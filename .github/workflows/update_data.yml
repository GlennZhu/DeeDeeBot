name: Update Macro Data Cache

on:
  schedule:
    - cron: "30 23 * * 1-5"
    - cron: "30 0 * * 2-6"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Evaluate Pacific schedule guard
        id: guard
        shell: bash
        run: |
          should_run="false"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            should_run="true"
          else
            local_dow="$(TZ=America/Los_Angeles date +%u)"
            local_hm="$(TZ=America/Los_Angeles date +%H:%M)"
            if [[ "$local_dow" -ge 1 && "$local_dow" -le 5 && "$local_hm" == "16:30" ]]; then
              should_run="true"
            fi
          fi

          echo "Pacific weekday=${local_dow:-manual}, time=${local_hm:-manual}"
          echo "run_pipeline=$should_run" >> "$GITHUB_OUTPUT"

      - name: Setup Python
        if: steps.guard.outputs.run_pipeline == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.guard.outputs.run_pipeline == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pipeline
        if: steps.guard.outputs.run_pipeline == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: python -m src.pipeline --macro-only

      - name: Commit changed CSV files
        id: commit_data
        if: steps.guard.outputs.run_pipeline == 'true'
        run: |
          if [[ -n "$(git status --porcelain data/raw data/derived/metric_snapshot.csv data/derived/signals_latest.csv data/derived/signal_events_7d.csv)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/raw data/derived/metric_snapshot.csv data/derived/signals_latest.csv data/derived/signal_events_7d.csv
            git commit -m "chore(data): update macro dashboard cache"
            git push
            echo "data_changed=true" >> "$GITHUB_OUTPUT"
            echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          else
            echo "No data changes detected."
            echo "data_changed=false" >> "$GITHUB_OUTPUT"
            echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Discord
        if: always() && steps.guard.outputs.run_pipeline == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          WORKFLOW_STATUS: ${{ job.status }}
          WORKFLOW_NAME: ${{ github.workflow }}
          REPOSITORY: ${{ github.repository }}
          REF_NAME: ${{ github.ref_name }}
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          RUN_NUMBER: ${{ github.run_number }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
          DATA_CHANGED: ${{ steps.commit_data.outputs.data_changed }}
          COMMIT_SHA: ${{ steps.commit_data.outputs.commit_sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [[ -z "$DISCORD_WEBHOOK_URL" ]]; then
            echo "Warning: DISCORD_WEBHOOK_URL is not set; skipping Discord notification."
            exit 0
          fi

          data_changed="${DATA_CHANGED:-unknown}"
          short_sha="unknown"
          if [[ -n "${COMMIT_SHA:-}" ]]; then
            short_sha="${COMMIT_SHA:0:7}"
          fi

          if [[ "$WORKFLOW_STATUS" == "success" && "$data_changed" == "true" ]]; then
            status_emoji="✅"
            status_title="Data refresh completed"
            change_note="CSV cache updated and pushed"
            status_color=5763719
          elif [[ "$WORKFLOW_STATUS" == "success" && "$data_changed" == "false" ]]; then
            status_emoji="✅"
            status_title="Data refresh completed"
            change_note="Refresh completed; no CSV changes detected"
            status_color=5763719
          elif [[ "$WORKFLOW_STATUS" == "success" ]]; then
            status_emoji="✅"
            status_title="Data refresh completed"
            change_note="Refresh completed (change detection unavailable)"
            status_color=5763719
          elif [[ "$WORKFLOW_STATUS" == "cancelled" ]]; then
            status_emoji="⚠️"
            status_title="Data refresh cancelled"
            change_note="Refresh run was cancelled before completion"
            status_color=15105570
          else
            status_emoji="❌"
            status_title="Data refresh failed"
            change_note="Refresh failed before completion"
            status_color=15548997
          fi

          timestamp_utc="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
          timestamp_pt="$(TZ=America/Los_Angeles date '+%Y-%m-%d %H:%M:%S %Z')"
          export status_emoji status_title change_note short_sha status_color timestamp_utc timestamp_pt

          payload="$(python3 - <<'PY'
          import json
          import os

          status_emoji = os.getenv("status_emoji", "ℹ️")
          status_title = os.getenv("status_title", "Data refresh update")
          workflow_status = os.getenv("WORKFLOW_STATUS", "unknown")
          change_note = os.getenv("change_note", "n/a")
          short_sha = os.getenv("short_sha", "unknown")
          status_color = int(os.getenv("status_color", "3447003"))
          repo = os.getenv("REPOSITORY", "unknown")
          ref_name = os.getenv("REF_NAME", "unknown")
          event_name = os.getenv("EVENT_NAME", "unknown")
          actor = os.getenv("ACTOR", "unknown")
          workflow_name = os.getenv("WORKFLOW_NAME", "unknown")
          run_number = os.getenv("RUN_NUMBER", "unknown")
          run_attempt = os.getenv("RUN_ATTEMPT", "1")
          run_url = os.getenv("RUN_URL", "")
          timestamp_utc = os.getenv("timestamp_utc", "")
          timestamp_pt = os.getenv("timestamp_pt", "")
          data_changed = os.getenv("DATA_CHANGED", "unknown")

          payload = {
              "content": f"{status_emoji} **{workflow_name}** run status: `{workflow_status}`",
              "embeds": [
                  {
                      "title": f"{status_emoji} {status_title}",
                      "url": run_url,
                      "color": status_color,
                      "description": change_note,
                      "fields": [
                          {"name": "Repository", "value": repo, "inline": True},
                          {"name": "Branch", "value": ref_name, "inline": True},
                          {"name": "Event", "value": event_name, "inline": True},
                          {"name": "Actor", "value": actor, "inline": True},
                          {"name": "Run", "value": f"#{run_number} (attempt {run_attempt})", "inline": True},
                          {"name": "Data Changed", "value": data_changed, "inline": True},
                          {"name": "Commit SHA", "value": short_sha, "inline": True},
                          {"name": "Status", "value": workflow_status, "inline": True},
                          {"name": "Completed (PT)", "value": timestamp_pt, "inline": False},
                      ],
                      "timestamp": timestamp_utc,
                  }
              ],
          }

          print(json.dumps(payload, separators=(",", ":")))
          PY
          )"

          curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "$DISCORD_WEBHOOK_URL" \
            || echo "Warning: Discord notification request failed."

      - name: Skip non-target schedule run
        if: steps.guard.outputs.run_pipeline != 'true'
        run: |
          echo "Skipping run: not 4:30 PM Pacific weekday."
